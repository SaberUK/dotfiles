#!/usr/bin/env ruby
# SaberUK's Dot Files (C) 2012-2016 Peter "SaberUK" Powell <petpow@saberuk.com>

unless system 'brew --version > /dev/null 2>&1'
	puts 'Fatal error: Homebrew is not installed and/or in the PATH!'
	exit 1
end

OUTPUT_FILE = 'install-homebrew-packages.sh'.freeze

File.open OUTPUT_FILE, 'w' do |fh|
	fh.puts '#!/bin/sh'
	fh.puts "# Generated using #{File.basename $PROGRAM_NAME} on #{Time.now}"
	fh.puts 'trap "exit 1" INT'

	`brew tap 2>/dev/null`.split.each do |tap|
		fh.puts "brew tap #{tap}"
	end

	`brew list 2>/dev/null`.split.each do |pkg|
		if `brew info #{pkg} 2>/dev/null` =~ /Built\sfrom\ssource\swith:\s(.+)+/
			fh.puts "brew install #{pkg} #{$~[1].gsub ',', ''}"
		else
			fh.puts "brew install #{pkg}"
		end
	end
end

File.chmod 0770, OUTPUT_FILE
