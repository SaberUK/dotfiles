#!/usr/bin/env ruby
# SaberUK's Dot Files (C) 2012-2019 Peter "SaberUK" Powell <petpow@saberuk.com>

unless system 'brew --version > /dev/null 2>&1'
	puts 'Fatal error: Homebrew is not installed and/or in the PATH!'
	exit 1
end

require 'json'

brew_packages = { }
brew_taps = [ 'homebrew/core' ]

JSON.parse(`brew info --installed --json=v1 2>/dev/null`).each do |pkg|
	if pkg['name'] != pkg['full_name'] && pkg['full_name'] =~ /^(?<tap>[^\s\\]+\/[^\s\\]+)\/\S+$/
		brew_taps << $~[:tap]
	end
	brew_packages[pkg['name']] = pkg['installed'].first['used_options']
end

OUTPUT_FILE = 'install-homebrew-packages.sh'.freeze

File.open OUTPUT_FILE, 'w' do |fh|
	fh.puts '#!/bin/sh'
	fh.puts "# Generated using #{File.basename $PROGRAM_NAME} on #{Time.now}"
	fh.puts 'trap "exit 1" INT'

	brew_taps.uniq.each do |tap|
		fh.puts "brew tap --full #{tap}"
	end

	brew_packages.each do |name, options|
		fh.puts "brew install #{name} #{options.join ' '}"
	end
end

File.chmod 0770, OUTPUT_FILE
